<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detector.js äº¤äº’æµ‹è¯•</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f8f9fa;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .test-panel {
      display: flex;
      flex-direction: column;
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .test-title {
      font-size: 18px;
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 15px;
      border-bottom: 2px solid #3498db;
      padding-bottom: 8px;
    }

    .controls {
      margin: 15px 0;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #3498db;
      color: white;
    }

    .btn-primary:hover {
      background: #2980b9;
    }

    .btn-success {
      background: #27ae60;
      color: white;
    }

    .btn-success:hover {
      background: #229954;
    }

    .btn-warning {
      background: #f39c12;
      color: white;
    }

    .btn-warning:hover {
      background: #e67e22;
    }

    .btn-danger {
      background: #e74c3c;
      color: white;
    }

    .btn-danger:hover {
      background: #c0392b;
    }

    .btn-purple {
      background: #a95cc8;
      color: white;
    }

    .btn-purple:hover {
      background: #9e48c1;
    }

    .event-log {
      background: #2c3e50;
      color: #ecf0f1;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 300px;
      overflow-y: auto;
      margin: 15px 0;
    }

    .event-item {
      margin: 3px 0;
      padding: 2px 0;
    }

    .event-get {
      color: #8fd2ff;
    }

    .event-set {
      color: #ff3b78;
    }

    .event-apply {
      color: #f9a521;
    }

    .event-construct {
      color: #db85ff;
    }

    .event-apply-resolved {
      color: #47f590;
    }

    .event-apply-rejected {
      color: #ff7566;
    }

    .stats {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin: 15px 0;
    }

    .stat-item {
      background: #ecf0f1;
      padding: 10px 15px;
      border-radius: 4px;
      text-align: center;
      min-width: 80px;
    }

    .stat-number {
      font-size: 24px;
      font-weight: bold;
      color: #2c3e50;
    }

    .stat-label {
      font-size: 12px;
      color: #7f8c8d;
    }

    .code-display {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 10px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      margin: 10px 0;
    }

    .toggle-group {
      display: flex;
      gap: 10px;
      align-items: center;
      margin: 10px 0;
    }

    input[type="checkbox"] {
      margin-right: 5px;
    }

    label {
      font-size: 14px;
      color: #2c3e50;
    }

    .clear-btn {
      background: #95a5a6;
      color: white;
      margin-left: auto;
    }

    .clear-btn:hover {
      background: #7f8c8d;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ” Detector.js äº¤äº’æµ‹è¯•é¢æ¿</h1>

    <!-- åŸºæœ¬å¯¹è±¡æ“ä½œæµ‹è¯• -->
    <div class="test-panel">
      <div class="test-title">ğŸ“¦ åŸºæœ¬å¯¹è±¡æ“ä½œ</div>

      <div class="toggle-group">
        <label><input type="checkbox"
                 id="enableBasic"
                 checked> å¯ç”¨æ£€æµ‹</label>
        <label><input type="checkbox"
                 id="filterBasic"> ä»…ç›‘å¬ name å±æ€§</label>
      </div>

      <div class="code-display">
        testObj = { name: "å¼ ä¸‰", age: 25, city: "åŒ—äº¬" }
      </div>

      <div class="controls">
        <button class="btn-primary"
                onclick="readName()">è¯»å– name</button>
        <button class="btn-primary"
                onclick="readAge()">è¯»å– age</button>
        <button class="btn-success"
                onclick="setName()">è®¾ç½® name</button>
        <button class="btn-success"
                onclick="setAge()">è®¾ç½® age</button>
        <button class="btn-warning"
                onclick="addProperty()">æ·»åŠ æ–°å±æ€§</button>
        <button class="btn-danger"
                onclick="deleteProperty()">åˆ é™¤å±æ€§</button>
      </div>

      <div class="stats">
        <div class="stat-item">
          <div class="stat-number"
               id="basicGetCount">0</div>
          <div class="stat-label">GET æ“ä½œ</div>
        </div>
        <div class="stat-item">
          <div class="stat-number"
               id="basicSetCount">0</div>
          <div class="stat-label">SET æ“ä½œ</div>
        </div>
        <div class="stat-item">
          <div class="stat-number"
               id="basicDeleteCount">0</div>
          <div class="stat-label">DELETE æ“ä½œ</div>
        </div>
      </div>

      <div class="event-log"
           id="basicLog">
        <div style="color: #95a5a6; text-align: center;">ç­‰å¾…æ“ä½œ...</div>
      </div>
      <button class="clear-btn"
              onclick="clearBasicLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <!-- å‡½æ•°è°ƒç”¨æµ‹è¯• -->
    <div class="test-panel">
      <div class="test-title">ğŸ”§ å‡½æ•°è°ƒç”¨æµ‹è¯•</div>

      <div class="code-display">
        api = {<br>
        &nbsp;&nbsp;add: (a, b) => a + b,<br>
        &nbsp;&nbsp;fetchData: async (id) => Promise.resolve(`æ•°æ®${id}`),<br>
        &nbsp;&nbsp;Calculator: function(initial) { this.value = initial; }<br>
        }
      </div>

      <div class="controls">
        <button class="btn-primary"
                onclick="callAdd()">è°ƒç”¨ add(5, 3)</button>
        <button class="btn-success"
                onclick="callAsync()">å¼‚æ­¥è°ƒç”¨ fetchData(123)</button>
        <button class="btn-danger"
                onclick="callAsyncError()">å¼‚æ­¥è°ƒç”¨ fetchError(123)</button>
        <button class="btn-purple"
                onclick="createInstance()">new Calculator(100)</button>
        <button class="btn-primary"
                onclick="accessFunction()">è®¿é—®å‡½æ•°å¯¹è±¡</button>
      </div>

      <div class="stats">
        <div class="stat-item">
          <div class="stat-number"
               id="funcCallCount">0</div>
          <div class="stat-label">å‡½æ•°è°ƒç”¨</div>
        </div>
        <div class="stat-item">
          <div class="stat-number"
               id="funcAsyncCount">0</div>
          <div class="stat-label">å¼‚æ­¥è§£æ</div>
        </div>
        <div class="stat-item">
          <div class="stat-number"
               id="funcConstructCount">0</div>
          <div class="stat-label">æ„é€ è°ƒç”¨</div>
        </div>
      </div>

      <div class="event-log"
           id="funcLog">
        <div style="color: #95a5a6; text-align: center;">ç­‰å¾…æ“ä½œ...</div>
      </div>
      <button class="clear-btn"
              onclick="clearFuncLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <!-- æ·±å±‚å¯¹è±¡æµ‹è¯• -->
    <div class="test-panel">
      <div class="test-title">ğŸŒŠ æ·±å±‚å¯¹è±¡è®¿é—®</div>

      <div class="toggle-group">
        <label>æ·±åº¦é™åˆ¶: <select id="depthLimit">
            <option value="1">1 å±‚</option>
            <option value="2"
                    selected>2 å±‚</option>
            <option value="3">3 å±‚</option>
            <option value="Infinity">æ— é™åˆ¶</option>
          </select></label>
      </div>

      <div class="code-display">
        deepObj = {<br>
        &nbsp;&nbsp;user: {<br>
        &nbsp;&nbsp;&nbsp;&nbsp;profile: {<br>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;settings: { theme: "æš—è‰²", lang: "zh" }<br>
        &nbsp;&nbsp;&nbsp;&nbsp;}<br>
        &nbsp;&nbsp;}<br>
        }
      </div>

      <div class="controls">
        <button class="btn-primary"
                onclick="accessDeep1()">è®¿é—® user</button>
        <button class="btn-primary"
                onclick="accessDeep2()">è®¿é—® user.profile</button>
        <button class="btn-primary"
                onclick="accessDeep3()">è®¿é—® user.profile.settings</button>
        <button class="btn-warning"
                onclick="accessDeepest()">è®¿é—® settings.theme</button>
        <button class="btn-success"
                onclick="setDeepValue()">ä¿®æ”¹æ·±å±‚å€¼</button>
      </div>

      <div class="stats">
        <div class="stat-item">
          <div class="stat-number"
               id="deepAccessCount">0</div>
          <div class="stat-label">è®¿é—®æ¬¡æ•°</div>
        </div>
        <div class="stat-item">
          <div class="stat-number"
               id="deepMaxDepth">0</div>
          <div class="stat-label">æœ€å¤§æ·±åº¦</div>
        </div>
      </div>

      <div class="event-log"
           id="deepLog">
        <div style="color: #95a5a6; text-align: center;">ç­‰å¾…æ“ä½œ...</div>
      </div>
      <button class="clear-btn"
              onclick="clearDeepLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <!-- å…¨å±€ç»Ÿè®¡ -->
    <div class="test-panel">
      <div class="test-title">ğŸ“Š å…¨å±€ç»Ÿè®¡</div>
      <div class="stats">
        <div class="stat-item">
          <div class="stat-number"
               id="totalEvents">0</div>
          <div class="stat-label">æ€»äº‹ä»¶æ•°</div>
        </div>
        <div class="stat-item">
          <div class="stat-number"
               id="totalGet">0</div>
          <div class="stat-label">GET</div>
        </div>
        <div class="stat-item">
          <div class="stat-number"
               id="totalSet">0</div>
          <div class="stat-label">SET</div>
        </div>
        <div class="stat-item">
          <div class="stat-number"
               id="totalApply">0</div>
          <div class="stat-label">APPLY</div>
        </div>
        <div class="stat-item">
          <div class="stat-number"
               id="totalOther">0</div>
          <div class="stat-label">å…¶ä»–</div>
        </div>
      </div>
      <button class="btn-danger"
              onclick="resetAll()">é‡ç½®æ‰€æœ‰</button>
    </div>
  </div>

  <script src="./detector.js"></script>
  <script>
    // å…¨å±€çŠ¶æ€
    let stats = {
      total: 0,
      get: 0,
      set: 0,
      apply: 0,
      construct: 0,
      delete: 0,
      resolved: 0,
      rejected: 0
    };

    // æµ‹è¯•å¯¹è±¡
    let testObj = { name: "å¼ ä¸‰", age: 25, city: "åŒ—äº¬" };
    let proxyTestObj = null;

    let api = {
      add: (a, b) => a + b,
      fetchData: async (id) => new Promise(resolve =>
        setTimeout(() => resolve(`æ•°æ®${id}`), 500)
      ),
      fetchError: async (id) => new Promise((resolve, reject) =>
        setTimeout(() => reject(new Error(`æ•°æ®${id}è·å–å¤±è´¥`)), 500)
      ),
      Calculator: function (initial) { this.value = initial; }
    };
    let proxyApi = null;

    let deepObj = {
      user: {
        profile: {
          settings: { theme: "æš—è‰²", lang: "zh" }
        }
      }
    };
    let proxyDeepObj = null;

    // åˆå§‹åŒ–ä»£ç†å¯¹è±¡
    function initProxies() {
      // åŸºæœ¬å¯¹è±¡ä»£ç†
      const enableBasic = document.getElementById('enableBasic').checked;
      const filterBasic = document.getElementById('filterBasic').checked;

      proxyTestObj = createDetector(testObj, (event) => {
        logEvent('basicLog', event);
        updateBasicStats(event);
        updateGlobalStats(event);
      }, {
        enable: enableBasic,
        include: filterBasic ? ['name'] : null
      });

      // å‡½æ•°å¯¹è±¡ä»£ç†
      proxyApi = createDetector(api, (event) => {
        logEvent('funcLog', event);
        updateFuncStats(event);
        updateGlobalStats(event);
      });

      // æ·±å±‚å¯¹è±¡ä»£ç†
      const depthLimit = document.getElementById('depthLimit').value;
      proxyDeepObj = createDetector(deepObj, (event) => {
        logEvent('deepLog', event);
        updateDeepStats(event);
        updateGlobalStats(event);
      }, {
        depthLimit: depthLimit === 'Infinity' ? Infinity : parseInt(depthLimit)
      });
    }

    // äº‹ä»¶æ—¥å¿—è®°å½•
    function logEvent(logId, event) {
      console.log('ğŸ¤– logEvent', logId, event);

      const logContainer = document.getElementById(logId);
      if (logContainer.children.length === 1 && logContainer.children[0].style.color === 'rgb(149, 165, 166)') {
        logContainer.innerHTML = '';
      }

      const eventDiv = document.createElement('div');
      eventDiv.className = `event-item event-${event.type.replace(':', '-')}`;

      let logText = `[${new Date().toLocaleTimeString()}] ${event.type.toUpperCase()}: ${event.accessor}`;

      if (event.args) {
        logText += `(${event.args.map(arg => JSON.stringify(arg)).join(', ')})`;
      }
      if (event.value !== undefined) {
        logText += ` = ${JSON.stringify(event.value)}`;
      }
      if (event.result !== undefined && !event.isPromise) {
        logText += ` â†’ ${JSON.stringify(event.result)}`;
      }
      if (event.isPromise) {
        logText += ` â†’ Promise${event.result && event.type === 'apply:resolved' ? ` âœ…${JSON.stringify(event.result)}` : ''}`;
      }
      if (event.error) {
        logText += ` âŒ${event.error.message}`;
      }

      eventDiv.textContent = logText;
      logContainer.appendChild(eventDiv);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    // ç»Ÿè®¡æ›´æ–°å‡½æ•°
    function updateBasicStats(event) {
      if (event.type === 'get') {
        incrementElement('basicGetCount');
      } else if (event.type === 'set') {
        incrementElement('basicSetCount');
      } else if (event.type === 'deleteProperty') {
        incrementElement('basicDeleteCount');
      }
    }

    function updateFuncStats(event) {
      if (event.type === 'apply') {
        incrementElement('funcCallCount');
      } else if (event.type === 'apply:resolved') {
        incrementElement('funcAsyncCount');
      } else if (event.type === 'construct') {
        incrementElement('funcConstructCount');
      }
    }

    function updateDeepStats(event) {
      incrementElement('deepAccessCount');
      const depth = event.path.length;
      const currentMaxDepth = parseInt(document.getElementById('deepMaxDepth').textContent);
      if (depth > currentMaxDepth) {
        document.getElementById('deepMaxDepth').textContent = depth;
      }
    }

    function updateGlobalStats(event) {
      stats.total++;
      document.getElementById('totalEvents').textContent = stats.total;

      if (event.type === 'get') {
        stats.get++;
        document.getElementById('totalGet').textContent = stats.get;
      } else if (event.type === 'set') {
        stats.set++;
        document.getElementById('totalSet').textContent = stats.set;
      } else if (event.type === 'apply' || event.type === 'apply:resolved' || event.type === 'apply:rejected') {
        stats.apply++;
        document.getElementById('totalApply').textContent = stats.apply;
      } else {
        stats.other = (stats.other || 0) + 1;
        document.getElementById('totalOther').textContent = stats.other;
      }
    }

    function incrementElement(id) {
      const el = document.getElementById(id);
      el.textContent = parseInt(el.textContent) + 1;
    }

    // åŸºæœ¬å¯¹è±¡æ“ä½œå‡½æ•°
    window.readName = () => {
      const result = proxyTestObj.name;
      console.log('è¯»å– name:', result);
    };

    window.readAge = () => {
      const result = proxyTestObj.age;
      console.log('è¯»å– age:', result);
    };

    window.setName = () => {
      const newName = prompt('è¾“å…¥æ–°çš„å§“å:', 'æå››') || 'æå››';
      proxyTestObj.name = newName;
      testObj.name = newName; // åŒæ­¥åŸå¯¹è±¡
    };

    window.setAge = () => {
      const newAge = parseInt(prompt('è¾“å…¥æ–°çš„å¹´é¾„:', '30')) || 30;
      proxyTestObj.age = newAge;
      testObj.age = newAge;
    };

    window.addProperty = () => {
      const key = prompt('å±æ€§å:', 'email') || 'email';
      const value = prompt('å±æ€§å€¼:', 'test@example.com') || 'test@example.com';
      proxyTestObj[key] = value;
      testObj[key] = value;
    };

    window.deleteProperty = () => {
      const key = prompt('åˆ é™¤å“ªä¸ªå±æ€§?', 'city') || 'city';
      delete proxyTestObj[key];
      delete testObj[key];
    };

    // å‡½æ•°è°ƒç”¨æµ‹è¯•å‡½æ•°
    window.callAdd = () => {
      const result = proxyApi.add(5, 3);
      console.log('add(5, 3) =', result);
    };

    window.callAsync = async () => {
      try {
        const result = await proxyApi.fetchData(123);
        console.log('fetchData(123) =', result);
      } catch (error) {
        console.error('å¼‚æ­¥è°ƒç”¨å¤±è´¥:', error);
      }
    };

    window.callAsyncError = async () => {
      try {
        const result = await proxyApi.fetchError(123);
        console.log('fetchError(123) =', result);
      } catch (error) {
        console.error('å¼‚æ­¥è°ƒç”¨å¤±è´¥:', error);
      }
    };

    window.createInstance = () => {
      const instance = new proxyApi.Calculator(100);
      console.log('new Calculator(100) =', instance);
    };

    window.accessFunction = () => {
      const func = proxyApi.add;
      console.log('è®¿é—®å‡½æ•°å¯¹è±¡:', typeof func);
    };

    // æ·±å±‚å¯¹è±¡æµ‹è¯•å‡½æ•°
    window.accessDeep1 = () => {
      const result = proxyDeepObj.user;
      console.log('user =', result);
    };

    window.accessDeep2 = () => {
      const result = proxyDeepObj.user.profile;
      console.log('user.profile =', result);
    };

    window.accessDeep3 = () => {
      const result = proxyDeepObj.user.profile.settings;
      console.log('user.profile.settings =', result);
    };

    window.accessDeepest = () => {
      const result = proxyDeepObj.user.profile.settings.theme;
      console.log('settings.theme =', result);
    };

    window.setDeepValue = () => {
      const newTheme = prompt('è®¾ç½®æ–°ä¸»é¢˜:', 'äº®è‰²') || 'äº®è‰²';
      proxyDeepObj.user.profile.settings.theme = newTheme;
      deepObj.user.profile.settings.theme = newTheme;
    };

    // æ¸…ç©ºæ—¥å¿—å‡½æ•°
    window.clearBasicLog = () => {
      document.getElementById('basicLog').innerHTML = '<div style="color: #95a5a6; text-align: center;">ç­‰å¾…æ“ä½œ...</div>';
    };

    window.clearFuncLog = () => {
      document.getElementById('funcLog').innerHTML = '<div style="color: #95a5a6; text-align: center;">ç­‰å¾…æ“ä½œ...</div>';
    };

    window.clearDeepLog = () => {
      document.getElementById('deepLog').innerHTML = '<div style="color: #95a5a6; text-align: center;">ç­‰å¾…æ“ä½œ...</div>';
    };

    // é‡ç½®æ‰€æœ‰ç»Ÿè®¡
    window.resetAll = () => {
      stats = { total: 0, get: 0, set: 0, apply: 0, construct: 0, delete: 0, resolved: 0, rejected: 0 };

      // é‡ç½®æ‰€æœ‰è®¡æ•°å™¨
      document.querySelectorAll('.stat-number').forEach(el => el.textContent = '0');

      // æ¸…ç©ºæ‰€æœ‰æ—¥å¿—
      clearBasicLog();
      clearFuncLog();
      clearDeepLog();

      // é‡æ–°åˆå§‹åŒ–ä»£ç†å¯¹è±¡
      initProxies();
    };

    // ç›‘å¬é…ç½®å˜åŒ–
    document.getElementById('enableBasic').addEventListener('change', initProxies);
    document.getElementById('filterBasic').addEventListener('change', initProxies);
    document.getElementById('depthLimit').addEventListener('change', initProxies);

    // åˆå§‹åŒ–
    initProxies();
  </script>
</body>

</html>